"""
Common handlers for all users
"""

from aiogram import Dispatcher
from aiogram.filters import Command
from aiogram.types import Message
from sqlalchemy import select
from sqlalchemy.orm import selectinload

from wpg_engine.core.engine import GameEngine
from wpg_engine.models import Player, PlayerRole, get_db


async def start_command(message: Message) -> None:
    """Handle /start command"""
    user_id = message.from_user.id

    async for db in get_db():
        game_engine = GameEngine(db)

        # Check if user is already registered
        result = await game_engine.db.execute(
            select(Player)
            .options(selectinload(Player.game), selectinload(Player.country))
            .where(Player.telegram_id == user_id)
            .limit(1)
        )
        player = result.scalar_one_or_none()

        # Check if user is admin (from .env)
        from wpg_engine.config.settings import settings

        is_admin_user = settings.telegram.admin_id and user_id == settings.telegram.admin_id

        # Check if any games exist
        from wpg_engine.models import Game

        result = await game_engine.db.execute(select(Game))
        existing_games = result.scalars().all()

        break

    if player:
        if player.role == PlayerRole.ADMIN:
            # Use HTML parsing to avoid markdown issues
            from html import escape

            display_name = escape(player.display_name)
            game_name = escape(player.game.name)

            await message.answer(
                f"üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>{display_name}</b>!\n\n"
                f"–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–≥—Ä—ã <b>{game_name}</b>.\n\n"
                f"<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
                f"üë§ /stats - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–µ\n"
                f"‚öôÔ∏è /admin - –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
                f"üìä /game_stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã\n"
                f"üéÆ /create_game - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É\n"
                f"üîÑ /register - –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω—É)",
                parse_mode="HTML",
            )
        else:
            # Use HTML parsing to avoid markdown issues
            from html import escape

            display_name = escape(player.display_name)
            country_name = escape(player.country.name if player.country else "—Å—Ç—Ä–∞–Ω—É –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞")
            game_name = escape(player.game.name)

            # List of example messages for random selection
            examples = [
                "–°–æ–±—Ä–∞—Ç—å –≤—Å–µ—Ö –¥–µ—Ç–µ–π –≤ –æ–≥—Ä–æ–º–Ω—É—é –≥–æ—Ä–æ–¥-—à–∫–æ–ª—É",
                "–ù–∞—á–∞—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ñ—Ç–∞",
                "–û–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É —Å–æ—Å–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–µ –∏–∑-–∑–∞ —Å–ø–æ—Ä–∞ –æ –≥—Ä–∞–Ω–∏—Ü–∞—Ö",
                "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–ª–∏–≥–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∫–ª–æ–Ω–µ–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º",
                "–ü—Ä–æ–≤–µ—Å—Ç–∏ –º–∞—Å—Å–æ–≤—É—é —ç–≤–∞–∫—É–∞—Ü–∏—é –Ω–∞—Å–µ–ª–µ–Ω–∏—è –≤ –ø–æ–¥–∑–µ–º–Ω—ã–µ –≥–æ—Ä–æ–¥–∞",
                "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—é –ø—É—Å—Ç—ã–Ω–∏ –≤ —Ü–≤–µ—Ç—É—â–∏–π —Å–∞–¥",
                "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –∏–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω–æ–π —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–µ–π",
                "–í–≤–µ—Å—Ç–∏ –≤—Å–µ–æ–±—â–∏–π –±–∞–∑–æ–≤—ã–π –¥–æ—Ö–æ–¥ –¥–ª—è –≤—Å–µ—Ö –≥—Ä–∞–∂–¥–∞–Ω",
                "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥–∏–≥–∞–Ω—Ç—Å–∫—É—é —Å—Ç–µ–Ω—É –≤–æ–∫—Ä—É–≥ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω—ã",
                "–û–±—ä—è–≤–∏—Ç—å –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ –≤ –º–∏—Ä–µ –≥–æ—Ä–æ–¥–∞ –Ω–∞ –≤–æ–¥–µ",
            ]

            import random

            random_example = random.choice(examples)

            await message.answer(
                f"üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>{display_name}</b>!\n\n"
                f"–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞ <b>{country_name}</b> "
                f"–≤ –∏–≥—Ä–µ <b>{game_name}</b>.\n\n"
                f"<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
                f"üë§ /stats - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–µ\n"
                f"üåç /world - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∞—Ö\n"
                f"üîÑ /register - –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω—É)\n\n"
                f"–Ω–∞–ø–∏—à–∏ —Å–≤–æ–µ, –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞—á–Ω–∏ –ø—Ä–æ–µ–∫—Ç! –ù–∞–ø—Ä–∏–º–µ—Ä: <code>{random_example}</code>",
                parse_mode="HTML",
            )
    elif is_admin_user:
        # Admin user but no games exist
        if not existing_games:
            await message.answer(
                "üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</b>!\n\n"
                "‚ùå –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä.\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /create_game –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã.\n"
                "–§–æ—Ä–º–∞—Ç: <code>/create_game –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã | –°–µ—Ç—Ç–∏–Ω–≥ | –õ–µ—Ç –∑–∞ —Å—É—Ç–∫–∏</code>\n\n"
                "–ü—Ä–∏–º–µ—Ä: <code>/create_game –î—Ä–µ–≤–Ω–∏–π –º–∏—Ä | –ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å | 10</code>",
                parse_mode="HTML",
            )
        else:
            await message.answer(
                "üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</b>!\n\n"
                "–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∏–≥—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /register –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
                parse_mode="HTML",
            )
    else:
        await message.answer(
            "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>WPG Engine</b>!\n\n"
            "–≠—Ç–æ –±–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–æ–µ–Ω–Ω–æ-–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–≥—Ä.\n\n"
            "–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∏–≥—Ä–µ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /register –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n\n"
            "<b>–ß—Ç–æ —Ç–∞–∫–æ–µ –í–ü–ò?</b>\n"
            "–í–æ–µ–Ω–Ω–æ-–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞ - —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è —Ä–æ–ª–µ–≤–∞—è –∏–≥—Ä–∞, "
            "–≥–¥–µ –∏–≥—Ä–æ–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç —Å—Ç—Ä–∞–Ω–∞–º–∏, —Ä–∞–∑–≤–∏–≤–∞—é—Ç –∏—Ö –ø–æ 10 –∞—Å–ø–µ–∫—Ç–∞–º "
            "–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º —á–µ—Ä–µ–∑ –¥–∏–ø–ª–æ–º–∞—Ç–∏—é, —Ç–æ—Ä–≥–æ–≤–ª—é –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.",
            parse_mode="HTML",
        )


async def help_command(message: Message) -> None:
    """Handle /help command"""
    user_id = message.from_user.id

    async for db in get_db():
        game_engine = GameEngine(db)

        # Check if user is registered
        result = await game_engine.db.execute(
            select(Player)
            .options(selectinload(Player.game), selectinload(Player.country))
            .where(Player.telegram_id == user_id)
            .limit(1)
        )
        player = result.scalar_one_or_none()
        break

    if not player:
        await message.answer(
            "<b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:</b>\n\n"
            "/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
            "/register - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∏–≥—Ä–µ (–∏–ª–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è)\n"
            "/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É",
            parse_mode="HTML",
        )
    elif player.role == PlayerRole.ADMIN:
        await message.answer(
            "<b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä):</b>\n\n"
            "<b>–û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            "/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "/stats - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–µ\n"
            "/register - –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω—É)\n"
            "/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n"
            "<b>–ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</b>\n"
            "/admin - –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
            "/game_stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã\n"
            "/create_game - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É\n"
            "/approve &lt;user_id&gt; - –æ–¥–æ–±—Ä–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é\n"
            "/reject &lt;user_id&gt; - –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é\n\n"
            "<b>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:</b>\n"
            "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É",
            parse_mode="HTML",
        )
    else:
        await message.answer(
            "<b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º (–ò–≥—Ä–æ–∫):</b>\n\n"
            "/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "/stats - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–µ\n"
            "/world - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∞—Ö\n"
            "/register - –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω—É)\n"
            "/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n"
            "<b>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:</b>\n"
            "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É",
            parse_mode="HTML",
        )


def register_common_handlers(dp: Dispatcher) -> None:
    """Register common handlers"""
    dp.message.register(start_command, Command("start"))
    dp.message.register(help_command, Command("help"))
