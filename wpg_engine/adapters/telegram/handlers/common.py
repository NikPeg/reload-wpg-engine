"""
Common handlers for all users
"""

from aiogram import Dispatcher
from aiogram.filters import Command
from aiogram.types import Message, ReplyKeyboardRemove
from sqlalchemy import func, select

from wpg_engine.adapters.telegram.utils import escape_html
from wpg_engine.core.admin_utils import is_admin
from wpg_engine.core.engine import GameEngine
from wpg_engine.models import Game, Player, PlayerRole, get_db


async def start_command(message: Message) -> None:
    """Handle /start command"""
    user_id = message.from_user.id

    async for db in get_db():
        game_engine = GameEngine(db)

        # Optimized: Load player with relations only if needed
        # First, do a lightweight check without loading relations
        result = await game_engine.db.execute(
            select(Player).where(Player.telegram_id == user_id).limit(1)
        )
        player = result.scalar_one_or_none()

        # Check if user is admin (uses cached admin check)
        is_admin_user = await is_admin(user_id, game_engine.db, message.chat.id)

        # Optimized: Check if any games exist using COUNT instead of loading all
        result = await game_engine.db.execute(select(func.count()).select_from(Game))
        has_games = result.scalar() > 0

        # Load game and country relations only if player exists
        if player:
            await game_engine.db.refresh(player, ["game", "country"])

        break

    # Check if user is admin from DB (before checking player in DB)
    if is_admin_user:
        # Admin user - show admin panel regardless of registration
        if player and player.role == PlayerRole.ADMIN and player.game:
            # Registered admin with game
            await message.answer(
                f"‚öôÔ∏è <b>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n\n"
                f"<b>–ò–≥—Ä–∞:</b> {escape_html(player.game.name)}\n"
                f"<b>–°–µ—Ç—Ç–∏–Ω–≥:</b> {escape_html(player.game.setting)}\n"
                f"<b>–°—Ç–∞—Ç—É—Å:</b> {escape_html(player.game.status)}\n"
                f"<b>–ú–∞–∫—Å –∏–≥—Ä–æ–∫–æ–≤:</b> {player.game.max_players}\n"
                f"<b>–õ–µ—Ç –∑–∞ —Å—É—Ç–∫–∏:</b> {player.game.years_per_day}\n"
                f"<b>–ú–∞–∫—Å –æ—á–∫–æ–≤:</b> {player.game.max_points}\n"
                f"<b>–ú–∞–∫—Å –Ω–∞—Å–µ–ª–µ–Ω–∏–µ:</b> {player.game.max_population:,}\n\n"
                f"<b>–ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</b>\n"
                f"‚Ä¢ /game_stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã\n"
                f"‚Ä¢ /active - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω (—Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –Ω–µ–¥–µ–ª—é)\n"
                f"‚Ä¢ /update_game - –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã\n"
                f"‚Ä¢ /restart_game - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É (–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)\n"
                f"‚Ä¢ /event - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º\n"
                f"‚Ä¢ /gen - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ (—Å –ò–ò)\n"
                f"‚Ä¢ /delete_country - —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω—É (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n"
                f"‚Ä¢ /delete_user - —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n\n"
                f"<b>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:</b>\n"
                f"‚Ä¢ /world - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∞—Ö\n"
                f"‚Ä¢ /world –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ\n\n"
                f"<b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω:</b>\n"
                f"‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /world –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n"
                f"‚Ä¢ –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç—Ä–∞–Ω–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n"
                f"‚Ä¢ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:\n"
                f"  - –Ω–∞–∑–≤–∞–Ω–∏–µ –ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ\n"
                f"  - –æ–ø–∏—Å–∞–Ω–∏–µ –ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ\n"
                f"  - —Å—Ç–æ–ª–∏—Ü–∞ –ù–æ–≤–∞—è —Å—Ç–æ–ª–∏—Ü–∞\n"
                f"  - –Ω–∞—Å–µ–ª–µ–Ω–∏–µ 1000000\n"
                f"  - —Å–∏–Ω–æ–Ω–∏–º—ã –†–ò, –†–∏–º (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)\n"
                f"  - —ç–∫–æ–Ω–æ–º–∏–∫–∞ 8 (–∑–Ω–∞—á–µ–Ω–∏—è –∞—Å–ø–µ–∫—Ç–æ–≤ 1-10)\n"
                f"  - —ç–∫–æ–Ω–æ–º–∏–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Å–ø–µ–∫—Ç–∞\n"
                f"  - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∞—Å–ø–µ–∫—Ç–æ–≤: –≤–æ–µ–Ω–Ω–æ–µ, –≤–Ω–µ—à–Ω—è—è, —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, —Ä–µ–ª–∏–≥–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –æ–±—â–µ—Å—Ç–≤–æ, —Ä–∞–∑–≤–µ–¥–∫–∞\n\n"
                f"<i>üí° –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∞. –ö–æ–º–∞–Ω–¥—ã /stats –∏ /send –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∞–º.</i>",
                parse_mode="HTML",
                reply_markup=ReplyKeyboardRemove(),
            )
        elif not has_games:
            # No games exist yet
            await message.answer(
                "üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</b>!\n\n"
                "‚ùå –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä.\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /restart_game –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã.\n"
                "–§–æ—Ä–º–∞—Ç: <code>/restart_game –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã | –°–µ—Ç—Ç–∏–Ω–≥ | –õ–µ—Ç –∑–∞ —Å—É—Ç–∫–∏ | –ú–∞–∫—Å –æ—á–∫–æ–≤ | –ú–∞–∫—Å –Ω–∞—Å–µ–ª–µ–Ω–∏–µ</code>\n\n"
                "–ü—Ä–∏–º–µ—Ä: <code>/restart_game –î—Ä–µ–≤–Ω–∏–π –º–∏—Ä | –ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å | 10 | 30 | 10000000</code>",
                parse_mode="HTML",
                reply_markup=ReplyKeyboardRemove(),
            )
        else:
            # Game exists but admin is not registered yet
            await message.answer(
                "üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</b>!\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /restart_game –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π –∏–ª–∏ /register –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –¥–ª—è —Å–µ–±—è.",
                parse_mode="HTML",
                reply_markup=ReplyKeyboardRemove(),
            )
    elif player:
        if player.role == PlayerRole.ADMIN:
            # Registered admin (not from .env) with game
            await message.answer(
                f"‚öôÔ∏è <b>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n\n"
                f"<b>–ò–≥—Ä–∞:</b> {escape_html(player.game.name)}\n"
                f"<b>–°–µ—Ç—Ç–∏–Ω–≥:</b> {escape_html(player.game.setting)}\n"
                f"<b>–°—Ç–∞—Ç—É—Å:</b> {escape_html(player.game.status)}\n"
                f"<b>–ú–∞–∫—Å –∏–≥—Ä–æ–∫–æ–≤:</b> {player.game.max_players}\n"
                f"<b>–õ–µ—Ç –∑–∞ —Å—É—Ç–∫–∏:</b> {player.game.years_per_day}\n"
                f"<b>–ú–∞–∫—Å –æ—á–∫–æ–≤:</b> {player.game.max_points}\n"
                f"<b>–ú–∞–∫—Å –Ω–∞—Å–µ–ª–µ–Ω–∏–µ:</b> {player.game.max_population:,}\n\n"
                f"<b>–ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</b>\n"
                f"‚Ä¢ /game_stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã\n"
                f"‚Ä¢ /active - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω (—Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –Ω–µ–¥–µ–ª—é)\n"
                f"‚Ä¢ /update_game - –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã\n"
                f"‚Ä¢ /restart_game - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É (–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)\n"
                f"‚Ä¢ /event - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º\n"
                f"‚Ä¢ /gen - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ (—Å –ò–ò)\n"
                f"‚Ä¢ /delete_country - —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω—É (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n"
                f"‚Ä¢ /delete_user - —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n\n"
                f"<b>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:</b>\n"
                f"‚Ä¢ /world - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∞—Ö\n"
                f"‚Ä¢ /world –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ\n\n"
                f"<b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω:</b>\n"
                f"‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /world –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n"
                f"‚Ä¢ –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç—Ä–∞–Ω–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n"
                f"‚Ä¢ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:\n"
                f"  - –Ω–∞–∑–≤–∞–Ω–∏–µ –ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ\n"
                f"  - –æ–ø–∏—Å–∞–Ω–∏–µ –ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ\n"
                f"  - —Å—Ç–æ–ª–∏—Ü–∞ –ù–æ–≤–∞—è —Å—Ç–æ–ª–∏—Ü–∞\n"
                f"  - –Ω–∞—Å–µ–ª–µ–Ω–∏–µ 1000000\n"
                f"  - —Å–∏–Ω–æ–Ω–∏–º—ã –†–ò, –†–∏–º (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)\n"
                f"  - —ç–∫–æ–Ω–æ–º–∏–∫–∞ 8 (–∑–Ω–∞—á–µ–Ω–∏—è –∞—Å–ø–µ–∫—Ç–æ–≤ 1-10)\n"
                f"  - —ç–∫–æ–Ω–æ–º–∏–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Å–ø–µ–∫—Ç–∞\n"
                f"  - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∞—Å–ø–µ–∫—Ç–æ–≤: –≤–æ–µ–Ω–Ω–æ–µ, –≤–Ω–µ—à–Ω—è—è, —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, —Ä–µ–ª–∏–≥–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –æ–±—â–µ—Å—Ç–≤–æ, —Ä–∞–∑–≤–µ–¥–∫–∞\n\n"
                f"<i>üí° –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∞. –ö–æ–º–∞–Ω–¥—ã /stats –∏ /send –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∞–º.</i>",
                parse_mode="HTML",
                reply_markup=ReplyKeyboardRemove(),
            )
        else:
            # Regular player
            # Use HTML parsing to avoid markdown issues
            display_name = escape_html(player.display_name)
            country_name = escape_html(
                player.country.name if player.country else "—Å—Ç—Ä–∞–Ω—É –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞"
            )
            game_name = escape_html(player.game.name)

            # List of example messages for random selection
            examples = [
                "–°–æ–±—Ä–∞—Ç—å –≤—Å–µ—Ö –¥–µ—Ç–µ–π –≤ –æ–≥—Ä–æ–º–Ω—É—é –≥–æ—Ä–æ–¥-—à–∫–æ–ª—É",
                "–ù–∞—á–∞—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ñ—Ç–∞",
                "–û–±—ä—è–≤–∏—Ç—å –≤–æ–π–Ω—É —Å–æ—Å–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–µ –∏–∑-–∑–∞ —Å–ø–æ—Ä–∞ –æ –≥—Ä–∞–Ω–∏—Ü–∞—Ö",
                "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–ª–∏–≥–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∫–ª–æ–Ω–µ–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º",
                "–ü—Ä–æ–≤–µ—Å—Ç–∏ –º–∞—Å—Å–æ–≤—É—é —ç–≤–∞–∫—É–∞—Ü–∏—é –Ω–∞—Å–µ–ª–µ–Ω–∏—è –≤ –ø–æ–¥–∑–µ–º–Ω—ã–µ –≥–æ—Ä–æ–¥–∞",
                "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—é –ø—É—Å—Ç—ã–Ω–∏ –≤ —Ü–≤–µ—Ç—É—â–∏–π —Å–∞–¥",
                "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –∏–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω–æ–π —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–µ–π",
                "–í–≤–µ—Å—Ç–∏ –≤—Å–µ–æ–±—â–∏–π –±–∞–∑–æ–≤—ã–π –¥–æ—Ö–æ–¥ –¥–ª—è –≤—Å–µ—Ö –≥—Ä–∞–∂–¥–∞–Ω",
                "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥–∏–≥–∞–Ω—Ç—Å–∫—É—é —Å—Ç–µ–Ω—É –≤–æ–∫—Ä—É–≥ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω—ã",
                "–û–±—ä—è–≤–∏—Ç—å –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ –≤ –º–∏—Ä–µ –≥–æ—Ä–æ–¥–∞ –Ω–∞ –≤–æ–¥–µ",
            ]

            import random

            random_example = random.choice(examples)

            await message.answer(
                f"üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>{display_name}</b>!\n\n"
                f"–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞ <b>{country_name}</b> "
                f"–≤ –∏–≥—Ä–µ <b>{game_name}</b>.\n\n"
                f"<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
                f"üë§ /stats - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–µ\n"
                f"üåç /world - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∞—Ö\n"
                f"üåç /world –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ\n"
                f"üì® /send - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–µ\n"
                f"üîÑ /register - –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω—É)\n\n"
                f"–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –ø—Ä–∏–∫–∞–∑, –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞—á–Ω–∏ –ø—Ä–æ–µ–∫—Ç! –ù–∞–ø—Ä–∏–º–µ—Ä: <code>{escape_html(random_example)}</code>",
                parse_mode="HTML",
                reply_markup=ReplyKeyboardRemove(),
            )
    else:
        await message.answer(
            "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>WPG Engine</b>!\n\n"
            "–≠—Ç–æ –±–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–æ–µ–Ω–Ω–æ-–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–≥—Ä.\n\n"
            "–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∏–≥—Ä–µ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /register –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n\n"
            "<b>–ß—Ç–æ —Ç–∞–∫–æ–µ –í–ü–ò?</b>\n"
            "–í–æ–µ–Ω–Ω–æ-–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞ - —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è —Ä–æ–ª–µ–≤–∞—è –∏–≥—Ä–∞, "
            "–≥–¥–µ –∏–≥—Ä–æ–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç —Å—Ç—Ä–∞–Ω–∞–º–∏, —Ä–∞–∑–≤–∏–≤–∞—é—Ç –∏—Ö –ø–æ 10 –∞—Å–ø–µ–∫—Ç–∞–º "
            "–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º —á–µ—Ä–µ–∑ –¥–∏–ø–ª–æ–º–∞—Ç–∏—é, —Ç–æ—Ä–≥–æ–≤–ª—é –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.",
            parse_mode="HTML",
            reply_markup=ReplyKeyboardRemove(),
        )


async def help_command(message: Message) -> None:
    """Handle /help command"""
    user_id = message.from_user.id

    async for db in get_db():
        game_engine = GameEngine(db)

        # Optimized: Only load what we need - no relations
        result = await game_engine.db.execute(
            select(Player).where(Player.telegram_id == user_id).limit(1)
        )
        player = result.scalar_one_or_none()
        break

    if not player:
        await message.answer(
            "<b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:</b>\n\n"
            "/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
            "/register - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∏–≥—Ä–µ\n"
            "/help - —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º",
            parse_mode="HTML",
        )
    elif player.role == PlayerRole.ADMIN:
        await message.answer(
            "<b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä):</b>\n\n"
            "<b>–ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</b>\n"
            "/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
            "/game_stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã\n"
            "/active - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω (—Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –Ω–µ–¥–µ–ª—é)\n"
            "/update_game - –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã\n"
            "/restart_game - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É (–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)\n"
            "/event - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º\n"
            "/gen - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ (—Å –ò–ò)\n"
            "/delete_country - —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω—É (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n"
            "/delete_user - —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n"
            "/help - —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º\n\n"
            "<b>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:</b>\n"
            "/world - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∞—Ö\n"
            "/world –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ\n\n"
            "<b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω:</b>\n"
            "‚Ä¢ /world –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä–∞–Ω–µ\n"
            "‚Ä¢ –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç—Ä–∞–Ω–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n"
            "‚Ä¢ –ö–æ–º–∞–Ω–¥—ã: –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Å—Ç–æ–ª–∏—Ü–∞, –Ω–∞—Å–µ–ª–µ–Ω–∏–µ, —Å–∏–Ω–æ–Ω–∏–º—ã, –∞—Å–ø–µ–∫—Ç—ã\n\n"
            "<i>üí° –ö–æ–º–∞–Ω–¥—ã /stats –∏ /send –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∞–º.</i>",
            parse_mode="HTML",
        )
    else:
        await message.answer(
            "<b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º (–ò–≥—Ä–æ–∫):</b>\n\n"
            "/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "/stats - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–µ\n"
            "/world - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∞—Ö\n"
            "/world –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ\n"
            "/send - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–µ\n"
            "/register - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω—É\n"
            "/help - —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º\n\n"
            "<b>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:</b>\n"
            "‚Ä¢ /send –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å—Ç—Ä–∞–Ω—ã - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–µ\n"
            "‚Ä¢ –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É",
            parse_mode="HTML",
        )


def register_common_handlers(dp: Dispatcher) -> None:
    """Register common handlers"""
    dp.message.register(start_command, Command("start"))
    dp.message.register(help_command, Command("help"))
