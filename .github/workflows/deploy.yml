name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: wpg-engine-bot

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        echo "üß™ Running tests..."
        python -m pytest tests/ -v --tb=short --strict-markers
        echo "‚úÖ All tests passed!"
      continue-on-error: false
    
    - name: Check test results
      if: failure()
      run: |
        echo "‚ùå Tests failed! Deployment will be blocked."
        exit 1

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff
    
    - name: Run linting
      run: |
        echo "üîç Running linter..."
        python -m ruff check .
        echo "‚úÖ Linting passed!"
    
    - name: Check formatting
      run: |
        echo "üé® Checking code formatting..."
        python -m ruff format --check .
        echo "‚úÖ Formatting is correct!"

  build-and-push:
    name: Build and Push Docker Image
    needs: [test, lint]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      deployment-status: "success"
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Yandex Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: json_key
        password: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: deploy/Dockerfile
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Yandex Cloud
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
    
    - name: Authenticate with Yandex Cloud
      run: |
        echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > key.json
        yc config profile create github-actions
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        rm key.json
    
    - name: Deploy to Yandex Cloud
      run: |
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Variables
        IMAGE_URL="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest"
        CONTAINER_NAME="wpg-engine-bot"
        
        # –†–∞—Å–∫—Ä—ã–≤–∞–µ–º $HOME —Å—Ä–∞–∑—É –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
        export DEPLOY_DIR="$HOME/wpg-engine"
        DATA_DIR="$DEPLOY_DIR/data"
        LOGS_DIR="$DEPLOY_DIR/logs"
        
        echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–µ–ø–ª–æ—è: $DEPLOY_DIR"
        
        # Stop and remove existing container (force remove if needed)
        echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
        
        # –ü–æ–ª—É—á–∞–µ–º ID –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∏–º–µ–Ω–µ–º wpg-engine-bot (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
        CONTAINER_IDS=$(docker ps -a --filter name=$CONTAINER_NAME --format "{{.ID}}" || true)
        
        if [ -n "$CONTAINER_IDS" ]; then
          echo "üóëÔ∏è  –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: $CONTAINER_IDS"
          for CONTAINER_ID in $CONTAINER_IDS; do
            echo "  –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–ª—è $CONTAINER_ID..."
            docker update --restart=no "$CONTAINER_ID" 2>/dev/null || true
            
            # –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            CONTAINER_PID=$(docker inspect "$CONTAINER_ID" --format '{{.State.Pid}}' 2>/dev/null || echo "")
            
            if [ -n "$CONTAINER_PID" ] && [ "$CONTAINER_PID" != "0" ]; then
              echo "  –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $CONTAINER_ID (PID: $CONTAINER_PID)..."
              sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
              sleep 1
            else
              echo "  –ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $CONTAINER_ID –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
            
            echo "  –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_ID..."
            docker rm -f "$CONTAINER_ID" 2>/dev/null || true
          done
          sleep 2
        fi
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if docker ps -a --filter name=$CONTAINER_NAME --format "{{.Names}}" | grep -q $CONTAINER_NAME; then
          echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–∏–º–µ–Ω—è–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –º–µ—Ä—ã..."
          
          # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - —É–±–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å
          REMAINING_IDS=$(docker ps -a --filter name=$CONTAINER_NAME --format "{{.ID}}")
          for CONTAINER_ID in $REMAINING_IDS; do
            CONTAINER_PID=$(docker inspect "$CONTAINER_ID" --format '{{.State.Pid}}' 2>/dev/null || echo "")
            if [ -n "$CONTAINER_PID" ] && [ "$CONTAINER_PID" != "0" ]; then
              echo "  –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ —É–±–∏–≤–∞–µ–º PID: $CONTAINER_PID..."
              sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
            fi
            sleep 1
            docker rm -f "$CONTAINER_ID" 2>/dev/null || true
          done
          sleep 2
          
          # –§–∏–Ω–∞–ª—å–Ω–∞—è-—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
          if docker ps -a --filter name=$CONTAINER_NAME --format "{{.Names}}" | grep -q $CONTAINER_NAME; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫!"
            docker ps -a --filter name=$CONTAINER_NAME
            exit 1
          fi
        fi
        
        echo "‚úÖ –í—Å–µ —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã"
        
        # Create directories in user home (no sudo needed)
        mkdir -p "$DATA_DIR" "$LOGS_DIR"
        
        # Login to Yandex Container Registry
        echo "Logging in to Yandex Container Registry..."
        echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' | docker login --username json_key --password-stdin ${{ env.REGISTRY }}
        
        # Pull new image
        docker pull $IMAGE_URL
        
        # Tag the image locally for reference
        docker tag $IMAGE_URL wpg-engine-bot:latest
        
        # Get the UID/GID of wpgbot user from the container and set proper permissions
        WPGBOT_UID=$(docker run --rm $IMAGE_URL id -u wpgbot 2>/dev/null || echo "999")
        WPGBOT_GID=$(docker run --rm $IMAGE_URL id -g wpgbot 2>/dev/null || echo "999")
        
        echo "Setting permissions for wpgbot user (UID: $WPGBOT_UID, GID: $WPGBOT_GID)"
        sudo chown -R $WPGBOT_UID:$WPGBOT_GID "$DATA_DIR" "$LOGS_DIR"
        chmod -R 755 "$DATA_DIR" "$LOGS_DIR"
        
        # Run new container with absolute paths
        docker run -d \
          --name $CONTAINER_NAME \
          --restart unless-stopped \
          -e TG_TOKEN="${{ secrets.TG_TOKEN || '' }}" \
          -e TG_ADMIN_ID="${{ secrets.TG_ADMIN_ID || '' }}" \
          -e AI_OPENROUTER_API_KEY="${{ secrets.AI_OPENROUTER_API_KEY || '' }}" \
          -e AI_DEFAULT_MODEL="${{ secrets.AI_DEFAULT_MODEL || 'deepseek/deepseek-chat-v3-0324' }}" \
          -e DB_URL="sqlite:///./data/wpg_engine.db" \
          -e LOG_LEVEL="INFO" \
          -v "$DATA_DIR:/app/data" \
          -v "$LOGS_DIR:/app/logs" \
          $IMAGE_URL
        
        # Clean up old images
        docker image prune -f
        
        # Logout from registry for security
        docker logout ${{ env.REGISTRY }}
        
        echo "‚úÖ Deployment completed successfully!"
        EOF
        
        # Make script executable
        chmod +x deploy.sh
        
        # Setup SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.YC_INSTANCE_IP }} >> ~/.ssh/known_hosts
        
        # Copy and execute deployment script on the server
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy.sh ${{ secrets.YC_INSTANCE_USER }}@${{ secrets.YC_INSTANCE_IP }}:/tmp/
        
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.YC_INSTANCE_USER }}@${{ secrets.YC_INSTANCE_IP }} \
          "chmod +x /tmp/deploy.sh && sudo /tmp/deploy.sh && rm /tmp/deploy.sh"
    
    - name: Verify deployment
      run: |
        sleep 30
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.YC_INSTANCE_USER }}@${{ secrets.YC_INSTANCE_IP }} \
          "docker ps | grep wpg-engine-bot && docker logs --tail 20 wpg-engine-bot"

  notify:
    name: Send Telegram Notification
    needs: [test, lint, build-and-push, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Send notification
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –∫–∞–∂–¥–æ–≥–æ job
          TEST_STATUS="${{ needs.test.result }}"
          LINT_STATUS="${{ needs.lint.result }}"
          BUILD_STATUS="${{ needs.build-and-push.result }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"
          
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
          format_status() {
            local status=$1
            local name=$2
            case "$status" in
              "success")
                echo "‚úÖ <b>${name}:</b> —É—Å–ø–µ—à–Ω–æ"
                ;;
              "failure")
                echo "‚ùå <b>${name}:</b> –æ—à–∏–±–∫–∞"
                ;;
              "cancelled")
                echo "‚ö†Ô∏è <b>${name}:</b> –æ—Ç–º–µ–Ω–µ–Ω"
                ;;
              "skipped")
                echo "‚è≠Ô∏è <b>${name}:</b> –ø—Ä–æ–ø—É—â–µ–Ω"
                ;;
              *)
                echo "‚ùì <b>${name}:</b> ${status:-–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}"
                ;;
            esac
          }
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ jobs —É—Å–ø–µ—à–Ω—ã (—É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ skipped –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—Ö–æ–º)
          ALL_SUCCESS=true
          if [ "$TEST_STATUS" != "success" ]; then
            ALL_SUCCESS=false
          fi
          if [ "$LINT_STATUS" != "success" ]; then
            ALL_SUCCESS=false
          fi
          if [ "$BUILD_STATUS" != "success" ] && [ "$BUILD_STATUS" != "skipped" ]; then
            ALL_SUCCESS=false
          fi
          if [ "$DEPLOY_STATUS" != "success" ] && [ "$DEPLOY_STATUS" != "skipped" ]; then
            ALL_SUCCESS=false
          fi
          
          if [ "$ALL_SUCCESS" = "true" ]; then
            EMOJI="‚úÖ"
            TITLE="<b>–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!</b>"
            STATUS_TEXT="–í—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
          else
            EMOJI="‚ùå"
            TITLE="<b>–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!</b>"
            STATUS_TEXT=""
            
            STATUS_TEXT="${STATUS_TEXT}$(format_status "${TEST_STATUS:-skipped}" "–¢–µ—Å—Ç—ã")%0A"
            STATUS_TEXT="${STATUS_TEXT}$(format_status "${LINT_STATUS:-skipped}" "–õ–∏–Ω—Ç–µ—Ä")%0A"
            STATUS_TEXT="${STATUS_TEXT}$(format_status "${BUILD_STATUS:-skipped}" "–°–±–æ—Ä–∫–∞")%0A"
            STATUS_TEXT="${STATUS_TEXT}$(format_status "${DEPLOY_STATUS:-skipped}" "–î–µ–ø–ª–æ–π")%0A"
          fi
          
          MESSAGE="${EMOJI} ${TITLE}%0A%0ACommit: <code>${COMMIT_SHA}</code>%0A${COMMIT_MSG}%0A%0A${STATUS_TEXT}%0A<a href='${WORKFLOW_URL}'>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Actions</a>"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TG_ADMIN_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=${MESSAGE}"