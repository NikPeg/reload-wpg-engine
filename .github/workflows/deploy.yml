name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: wpg-engine-bot

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        python -m pytest tests/ -v --tb=short --strict-markers
        echo "âœ… All tests passed!"
      continue-on-error: false
    
    - name: Check test results
      if: failure()
      run: |
        echo "âŒ Tests failed! Deployment will be blocked."
        exit 1

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff
    
    - name: Run linting
      run: |
        echo "ðŸ” Running linter..."
        python -m ruff check .
        echo "âœ… Linting passed!"
    
    - name: Check formatting
      run: |
        echo "ðŸŽ¨ Checking code formatting..."
        python -m ruff format --check .
        echo "âœ… Formatting is correct!"

  build-and-push:
    name: Build and Push Docker Image
    needs: [test, lint]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      deployment-status: "success"
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Yandex Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: json_key
        password: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: deploy/Dockerfile
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Yandex Cloud
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
    
    - name: Authenticate with Yandex Cloud
      run: |
        echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > key.json
        yc config profile create github-actions
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        rm key.json
    
    - name: Deploy to Yandex Cloud
      run: |
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Variables
        IMAGE_URL="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest"
        CONTAINER_NAME="wpg-engine-bot"
        
        # Ð Ð°ÑÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ $HOME ÑÑ€Ð°Ð·Ñƒ Ð² Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ
        export DEPLOY_DIR="$HOME/wpg-engine"
        DATA_DIR="$DEPLOY_DIR/data"
        LOGS_DIR="$DEPLOY_DIR/logs"
        
        echo "ðŸ“ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ: $DEPLOY_DIR"
        
        # Stop and remove existing container (force remove if needed)
        echo "â¸ï¸  ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ID Ð²ÑÐµÑ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼ wpg-engine-bot (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ)
        CONTAINER_IDS=$(docker ps -a --filter name=$CONTAINER_NAME --format "{{.ID}}" || true)
        
        if [ -n "$CONTAINER_IDS" ]; then
          echo "ðŸ—‘ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ: $CONTAINER_IDS"
          for CONTAINER_ID in $CONTAINER_IDS; do
            echo "  ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð´Ð»Ñ $CONTAINER_ID..."
            docker update --restart=no "$CONTAINER_ID" 2>/dev/null || true
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ PID Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
            CONTAINER_PID=$(docker inspect "$CONTAINER_ID" --format '{{.State.Pid}}' 2>/dev/null || echo "")
            
            if [ -n "$CONTAINER_PID" ] && [ "$CONTAINER_PID" != "0" ]; then
              echo "  Ð£Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° $CONTAINER_ID (PID: $CONTAINER_PID)..."
              sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
              sleep 1
            else
              echo "  ÐŸÑ€Ð¾Ñ†ÐµÑÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° $CONTAINER_ID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ ÑƒÐ¶Ðµ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
            fi
            
            echo "  Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ $CONTAINER_ID..."
            docker rm -f "$CONTAINER_ID" 2>/dev/null || true
          done
          sleep 2
        fi
        
        # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
        if docker ps -a --filter name=$CONTAINER_NAME --format "{{.Names}}" | grep -q $CONTAINER_NAME; then
          echo "âš ï¸  ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð²ÑÐµ ÐµÑ‰Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ ÑÐºÑÑ‚Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð¼ÐµÑ€Ñ‹..."
          
          # ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° - ÑƒÐ±Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ð¸ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ
          REMAINING_IDS=$(docker ps -a --filter name=$CONTAINER_NAME --format "{{.ID}}")
          for CONTAINER_ID in $REMAINING_IDS; do
            CONTAINER_PID=$(docker inspect "$CONTAINER_ID" --format '{{.State.Pid}}' 2>/dev/null || echo "")
            if [ -n "$CONTAINER_PID" ] && [ "$CONTAINER_PID" != "0" ]; then
              echo "  Ð­ÐºÑÑ‚Ñ€ÐµÐ½Ð½Ð¾ ÑƒÐ±Ð¸Ð²Ð°ÐµÐ¼ PID: $CONTAINER_PID..."
              sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
            fi
            sleep 1
            docker rm -f "$CONTAINER_ID" 2>/dev/null || true
          done
          sleep 2
          
          # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ-Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
          if docker ps -a --filter name=$CONTAINER_NAME --format "{{.Names}}" | grep -q $CONTAINER_NAME; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð²ÑÐµ ÐµÑ‰Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ Ð²ÑÐµÑ… Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº!"
            docker ps -a --filter name=$CONTAINER_NAME
            exit 1
          fi
        fi
        
        echo "âœ… Ð’ÑÐµ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
        
        # Create directories in user home (no sudo needed)
        mkdir -p "$DATA_DIR" "$LOGS_DIR"
        
        # Login to Yandex Container Registry
        echo "Logging in to Yandex Container Registry..."
        echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' | docker login --username json_key --password-stdin ${{ env.REGISTRY }}
        
        # Pull new image
        docker pull $IMAGE_URL
        
        # Tag the image locally for reference
        docker tag $IMAGE_URL wpg-engine-bot:latest
        
        # Get the UID/GID of wpgbot user from the container and set proper permissions
        WPGBOT_UID=$(docker run --rm $IMAGE_URL id -u wpgbot 2>/dev/null || echo "999")
        WPGBOT_GID=$(docker run --rm $IMAGE_URL id -g wpgbot 2>/dev/null || echo "999")
        
        echo "Setting permissions for wpgbot user (UID: $WPGBOT_UID, GID: $WPGBOT_GID)"
        sudo chown -R $WPGBOT_UID:$WPGBOT_GID "$DATA_DIR" "$LOGS_DIR"
        chmod -R 755 "$DATA_DIR" "$LOGS_DIR"
        
        # Run new container with absolute paths
        docker run -d \
          --name $CONTAINER_NAME \
          --restart unless-stopped \
          -e TG_TOKEN="${{ secrets.TG_TOKEN || '' }}" \
          -e TG_ADMIN_ID="${{ secrets.TG_ADMIN_ID || '' }}" \
          -e AI_OPENROUTER_API_KEY="${{ secrets.AI_OPENROUTER_API_KEY || '' }}" \
          -e AI_DEFAULT_MODEL="${{ secrets.AI_DEFAULT_MODEL || 'deepseek/deepseek-chat-v3-0324' }}" \
          -e DB_URL="sqlite:///./data/wpg_engine.db" \
          -e LOG_LEVEL="INFO" \
          -v "$DATA_DIR:/app/data" \
          -v "$LOGS_DIR:/app/logs" \
          $IMAGE_URL
        
        # Clean up old images
        docker image prune -f
        
        # Logout from registry for security
        docker logout ${{ env.REGISTRY }}
        
        echo "âœ… Deployment completed successfully!"
        EOF
        
        # Make script executable
        chmod +x deploy.sh
        
        # Setup SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.YC_INSTANCE_IP }} >> ~/.ssh/known_hosts
        
        # Copy and execute deployment script on the server
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy.sh ${{ secrets.YC_INSTANCE_USER }}@${{ secrets.YC_INSTANCE_IP }}:/tmp/
        
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.YC_INSTANCE_USER }}@${{ secrets.YC_INSTANCE_IP }} \
          "chmod +x /tmp/deploy.sh && sudo /tmp/deploy.sh && rm /tmp/deploy.sh"
    
    - name: Verify deployment
      run: |
        sleep 30
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.YC_INSTANCE_USER }}@${{ secrets.YC_INSTANCE_IP }} \
          "docker ps | grep wpg-engine-bot && docker logs --tail 20 wpg-engine-bot"