# Admin Chat Support

## Описание

Переменная окружения `TG_ADMIN_ID` теперь поддерживает два режима работы:

1. **Режим пользователя-админа** (положительное значение) - традиционный режим, когда указанный пользователь является администратором
2. **Режим админского чата** (отрицательное значение) - новый режим, когда все сообщения из указанного чата считаются сообщениями администратора

## Использование

### Режим пользователя-админа

Установите `TG_ADMIN_ID` на положительное значение (ID пользователя в Telegram):

```bash
TG_ADMIN_ID=123456789
```

В этом случае только указанный пользователь будет иметь права администратора, независимо от того, откуда он пишет (из личных сообщений или из чата).

### Режим админского чата

Установите `TG_ADMIN_ID` на отрицательное значение (ID чата/группы в Telegram):

```bash
TG_ADMIN_ID=-1001234567890
```

В этом случае все пользователи, пишущие из указанного чата, будут считаться администраторами. Это удобно, когда:
- Несколько человек управляют ботом из одного чата
- Нужно разделить админские обсуждения и команды от личных сообщений
- Хочется иметь общий чат для команды администраторов

**Важно**: Режимы можно комбинировать - можно иметь и пользователя-админа, и админский чат одновременно. Пользователь-админ будет администратором везде, а пользователи из админского чата - только когда пишут из этого чата.

## Как получить ID чата

1. Добавьте бота в группу/чат
2. Отправьте любое сообщение в чат
3. Используйте специальный бот (например, [@userinfobot](https://t.me/userinfobot)) или API для получения ID чата
4. ID чата для групп всегда отрицательный и начинается с `-100`

Пример ID чата: `-1001234567890`

## Технические детали

### Изменения в коде

1. **`TelegramSettings`** в `wpg_engine/config/settings.py`:
   - Добавлены методы `is_admin_chat()` и `is_admin_user()` для определения типа админа

2. **`is_admin_from_env()`** в `wpg_engine/core/admin_utils.py`:
   - Новая функция для проверки, является ли пользователь/чат админом из переменной окружения
   - Принимает `telegram_id` (ID пользователя) и `chat_id` (ID чата, если сообщение из чата)

3. **`determine_player_role()`** и `is_admin()`**:
   - Обновлены для поддержки параметра `chat_id`
   - Используют `is_admin_from_env()` для проверки прав

4. **Обработчики сообщений**:
   - Все обработчики обновлены для передачи `chat_id` в функции проверки прав
   - `message.chat.id` теперь передается везде, где проверяются права администратора

### Примеры использования в коде

```python
from wpg_engine.core.admin_utils import is_admin, is_admin_from_env

# Проверка, является ли пользователь админом (учитывая чат)
is_user_admin = await is_admin(
    telegram_id=user_id,
    db=db,
    chat_id=message.chat.id  # Передаем ID чата
)

# Проверка только по переменной окружения
is_env_admin = is_admin_from_env(
    telegram_id=user_id,
    chat_id=message.chat.id
)
```

## Тестирование

Добавлены юнит-тесты в `tests/test_admin_chat.py`, которые покрывают:
- Определение типа админа (чат vs пользователь)
- Проверку прав в различных сценариях
- Корректную работу с базой данных и без неё

Запуск тестов:

```bash
python -m pytest tests/test_admin_chat.py -v
```

