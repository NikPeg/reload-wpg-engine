# Docker Cache Guide

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –∫—ç—à–µ–º Docker –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ WPG Engine.

## üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—ç—à Docker

Docker –∫—ç—à–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π —Å–ª–æ–π (layer) –æ–±—Ä–∞–∑–∞. –ö–∞–∂–¥–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ Dockerfile —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Å–ª–æ–π:

```dockerfile
FROM python:3.11-slim          # –°–ª–æ–π 1 - –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑
RUN apt-get update...          # –°–ª–æ–π 2 - —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã  
RUN groupadd -r wpgbot...      # –°–ª–æ–π 3 - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
WORKDIR /app                   # –°–ª–æ–π 4 - —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
COPY requirements.txt .        # –°–ª–æ–π 5 - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN pip install...             # –°–ª–æ–π 6 - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
COPY . .                       # –°–ª–æ–π 7 - –í–ê–® –ö–û–î
```

## ‚úÖ –ö–æ–≥–¥–∞ –∫—ç—à –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

- Dockerfile –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- –§–∞–π–ª—ã, –∫–æ–ø–∏—Ä—É–µ–º—ã–µ –≤ —Å–ª–æ–π, –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å  
- –ö–æ–º–∞–Ω–¥—ã RUN –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
- –í –≤—ã–≤–æ–¥–µ –≤–∏–¥–∏—Ç–µ `CACHED`

## ‚ùå –ö–æ–≥–¥–∞ –∫—ç—à –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

- –ò–∑–º–µ–Ω–∏–ª–∏ –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ (–≤–ª–∏—è–µ—Ç –Ω–∞ `COPY . .`)
- –ò–∑–º–µ–Ω–∏–ª–∏ `requirements.txt` (–≤–ª–∏—è–µ—Ç –Ω–∞ `pip install`)
- –ò–∑–º–µ–Ω–∏–ª–∏ Dockerfile
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ñ–ª–∞–≥ `--no-cache`

## üîÑ –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ Python
```bash
# –ò–∑–º–µ–Ω–∏–ª–∏ main.py, wpg_engine/*.py –∏ —Ç.–¥.
make run    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å–æ–±–µ—Ä–µ—Ç –æ–±—Ä–∞–∑
```

### –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
# –ò–∑–º–µ–Ω–∏–ª–∏ requirements.txt
make down
make run    # –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—Å–µ –ø–∞–∫–µ—Ç—ã
```

### –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Dockerfile
```bash
# –ò–∑–º–µ–Ω–∏–ª–∏ Dockerfile (–¥–æ–±–∞–≤–∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –∏ —Ç.–¥.)
make down
docker-compose build --no-cache
docker-compose up -d
```

### –ü—Ä–∏ —Å—Ç—Ä–∞–Ω–Ω–æ–º –ø–æ–≤–µ–¥–µ–Ω–∏–∏
```bash
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ –∫—ç—à–∞
make clean
docker build --no-cache -t wpg-engine .
make run
```

## üîç –ö–∞–∫ –ø–æ–Ω—è—Ç—å —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

–°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã `docker build`:

```bash
=> CACHED [2/9] RUN apt-get update...     # ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à
=> [7/9] COPY --chown=wpgbot:wpgbot . .   # ‚Üê –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç (–Ω–µ—Ç CACHED)
```

## üí° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—ç—à–∞

–ù–∞—à Dockerfile —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞:

1. **–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã** (–∏–∑–º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ) ‚Üí –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–æ–ª–≥–æ
2. **Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** (–∏–∑–º–µ–Ω—è—é—Ç—Å—è —Å—Ä–µ–¥–Ω–µ) ‚Üí –∫—ç—à–∏—Ä—É—é—Ç—Å—è –ø–æ–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è `requirements.txt`
3. **–ö–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (–∏–∑–º–µ–Ω—è–µ—Ç—Å—è —á–∞—Å—Ç–æ) ‚Üí –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã

| –°–∏—Ç—É–∞—Ü–∏—è | –ö–æ–º–∞–Ω–¥–∞ |
|----------|---------|
| –ò–∑–º–µ–Ω–∏–ª –∫–æ–¥ | `make run` |
| –î–æ–±–∞–≤–∏–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å | `make down && make run` |
| –ò–∑–º–µ–Ω–∏–ª Dockerfile | `docker-compose build --no-cache && docker-compose up -d` |
| –ß—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å | `make clean && docker build --no-cache -t wpg-engine . && make run` |

## üéØ –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –æ–±—Ä–∞–∑—ã
docker images

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä —Å–ª–æ–µ–≤
docker history wpg-engine

# –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
docker image prune

# –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à Docker (–û–°–¢–û–†–û–ñ–ù–û!)
docker system prune -a
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

- **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--no-cache` –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏** - —ç—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–±–æ—Ä–∫—É
- **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –∫–æ–¥–∞ Python** –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ `make run`
- **–ö—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É "–∏–∑–º–µ–Ω–∏–ª—Å—è –æ–¥–∏–Ω —Å–ª–æ–π = –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ"**
- **–ü–æ—Ä—è–¥–æ–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤ Dockerfile –≤–∞–∂–µ–Ω –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è**

## üîß Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–¥ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
```bash
# –†–µ—à–µ–Ω–∏–µ: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
make down
docker-compose build --no-cache
docker-compose up -d
```

### –ü—Ä–æ–±–ª–µ–º–∞: –î–æ–ª–≥–∞—è —Å–±–æ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ requirements.txt –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ .dockerignore –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ —Ç–∏–ø–∞ "file not found" –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
```bash
# –í–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫—ç—à, –æ—á–∏—Å—Ç–∏—Ç–µ –µ–≥–æ
docker build --no-cache -t wpg-engine .