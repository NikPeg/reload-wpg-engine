# Выбор страны из примеров с использованием FSM

## Описание

Реализована возможность выбора готовой страны из примеров во время процесса регистрации с использованием FSM (Finite State Machine) от aiogram.

## Как это работает

### Для пользователя

1. Пользователь начинает регистрацию командой `/register`
2. Если есть доступные примеры стран, бот сообщает об этом и предлагает использовать `/examples`
3. Пользователь может в любой момент регистрации:
   - Посмотреть примеры командой `/examples`
   - Ответить на сообщение с примером словами **"выбрать"** или **"выбираю"**
4. При выборе примера:
   - Регистрация завершается автоматически
   - Пользователь получает выбранную страну
   - Пример удаляется из базы данных (страна становится недоступна для других)
   - Уведомление отправляется администратору

### Технические детали

#### Изменения в `registration.py`

1. **Добавлен фильтр `IsExampleSelection`**
   ```python
   class IsExampleSelection(Filter):
       """Filter to check if message is selecting an example during registration"""
   ```
   - Проверяет, что сообщение является ответом
   - Проверяет, что пользователь находится в состоянии регистрации
   - Проверяет наличие маркера `[EXAMPLE:X]` в сообщении
   - Проверяет, что текст содержит "выбрать" или "выбираю"

2. **Добавлена функция `process_example_selection`**
   - Извлекает ID примера из маркера
   - Проверяет доступность примера
   - Создает или обновляет игрока с выбранной страной
   - Удаляет пример из базы данных
   - Отправляет уведомление пользователю и администратору
   - Очищает состояние FSM

3. **Обновлена команда `/register`**
   - Проверяет наличие примеров в игре
   - Добавляет подсказку об использовании `/examples` если примеры есть

4. **Зарегистрирован новый обработчик**
   ```python
   dp.message.register(
       process_example_selection,
       IsExampleSelection(),
   )
   ```
   - Регистрируется **ПЕРВЫМ** в списке обработчиков
   - Перехватывает сообщения с выбором примера на любом этапе регистрации

## Преимущества решения

1. **Работает на любом этапе регистрации** - пользователь может выбрать пример когда угодно
2. **Не требует отдельного состояния** - использует существующие состояния регистрации
3. **Атомарность** - пример удаляется сразу после выбора, предотвращая дублирование
4. **Чистый код** - фильтр изолирует логику проверки от логики обработки
5. **Покрыто тестами** - 6 новых интеграционных тестов

## Тестирование

### Юнит-тесты (`test_example_selection.py`)
- Базовая функциональность выбора примеров
- Проверка удаления примера после выбора
- Проверка сохранности страны после удаления примера

### Интеграционные тесты (`test_registration_with_examples.py`)
- Тестирование фильтра `IsExampleSelection`
- Успешный выбор примера
- Обработка ошибок (пример не найден, не является ответом, неправильный текст)
- Выбор примера из разных состояний регистрации

Все тесты проходят успешно (108/115 тестов проекта, 7 падающих тестов не связаны с нашими изменениями).

## Примеры использования

### Сценарий 1: Выбор примера в начале регистрации
```
User: /register
Bot: Регистрация в игре... Используйте /examples для просмотра примеров
User: /examples
Bot: [Отображает примеры стран с маркерами [EXAMPLE:1], [EXAMPLE:2], ...]
User: (отвечает на сообщение с примером) выбрать
Bot: Поздравляем! Вы выбрали страну Example Country!
```

### Сценарий 2: Выбор примера посередине регистрации
```
User: /register
Bot: Как будет называться ваша страна?
User: Моя Страна
Bot: Как называется столица?
User: /examples
Bot: [Отображает примеры]
User: (отвечает на пример) выбираю
Bot: Поздравляем! Вы выбрали страну Example Country!
```

## Структура кода

```
wpg_engine/adapters/telegram/handlers/registration.py
├── IsExampleSelection (Filter)
├── process_example_selection (Handler)
├── register_command (обновлена)
└── register_registration_handlers (обновлена)

tests/
├── test_example_selection.py (5 тестов)
└── test_registration_with_examples.py (6 новых тестов)
```

## Возможные улучшения

1. Добавить возможность предпросмотра страны перед выбором
2. Добавить подтверждение выбора ("Вы уверены?")
3. Добавить возможность отмены выбора
4. Показывать количество доступных примеров
5. Добавить фильтрацию примеров по параметрам

